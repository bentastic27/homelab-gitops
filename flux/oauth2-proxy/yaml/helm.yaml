apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: oauth2-proxy
  namespace: flux
spec:
  interval: 10m0s
  url: https://oauth2-proxy.github.io/manifests
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: flux
spec:
  interval: 10m
  timeout: 5m
  releaseName: oauth2-proxy
  targetNamespace: oauth2-proxy
  install:
    createNamespace: true
  chart:
    spec:
      chart: oauth2-proxy
      version: "8.3.3"
      sourceRef:
        kind: HelmRepository
        name: oauth2-proxy
      interval: 5m
  values:
    config:
      configFile: |-
        email_domains = ["*"]
        cookie_domains = ["beansnet.net", ".beansnet.net", "int.beansnet.net", ".int.beansnet.net"]
        whitelist_domains = ["beansnet.net", ".beansnet.net", "int.beansnet.net", ".int.beansnet.net"]
        redirect_url = "/oauth2/callback"
        provider = "keycloak-oidc"
        oidc_issuer_url = "https://keycloak.int.beansnet.net/realms/master"
        allowed_groups = ["/oauth2-proxy"]
        session_store_type = "redis"
        redis_connection_url = "redis://valkey.oauth2-proxy.svc.cluster.local"
    envFrom:
    - secretRef:
        name: keycloak
    metrics:
      serviceMonitor:
        namespace: prometheus
    customLabels:
      istio.io/ingress-use-waypoint: "true"
      istio.io/dataplane-mode: ambient
      istio.io/use-waypoint: shared-waypoint
      istio.io/use-waypoint-namespace: istio-system
  postRenderers:
  - kustomize:
      patches:
      - target:
          version: v1
          kind: Deployment
          name: oauth2-proxy
        patch: |
          - op: remove
            path: /spec/template/spec/containers/0/env